# -*- coding: utf-8 -*-
"""Copy of GEN ai-11a.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1u8LbwiGJAfEpd4tcoCO23VX8WKLHKIF2
"""

!pip install fastapi uvicorn pyngrok nest_asyncio

!ngrok config add-authtoken 33gIBhr6wU4dYniiWVpjGBqdEbt_3ZdmNGK2V4Rswr8K3bAYm

import nest_asyncio
from pyngrok import ngrok
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List
import uvicorn
import asyncio

!pip install fastapi uvicorn pyngrok nest_asyncio

import nest_asyncio
import uvicorn
import asyncio
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import List, Optional
from pyngrok import ngrok
from datetime import datetime
import uuid

# Allow nested event loops
nest_asyncio.apply()

# Configure ngrok with your authtoken
NGROK_AUTHTOKEN = "33gIBhr6wU4dYniiWVpjGBqdEbt_3ZdmNGK2V4Rswr8K3bAYm"
ngrok.set_auth_token(NGROK_AUTHTOKEN)
print("âœ… Ngrok authtoken configured successfully!")

# FastAPI app
app = FastAPI(
    title="Chat App",
    description="A simple real-time chat application",
    version="1.0.0"
)

# Enhanced message storage
chat_history = []

class Message(BaseModel):
    sender: str
    text: str
    message_id: Optional[str] = None
    timestamp: Optional[str] = None

@app.post("/chat", response_model=dict)
async def send_message(message: Message):
    """Send a new message to the chat"""
    try:
        # Add metadata
        message_dict = message.dict()
        message_dict["message_id"] = str(uuid.uuid4())
        message_dict["timestamp"] = datetime.now().isoformat()

        chat_history.append(message_dict)

        # Keep only last 100 messages to prevent memory issues
        if len(chat_history) > 100:
            chat_history.pop(0)

        return {
            "status": "Message received",
            "message_id": message_dict["message_id"],
            "timestamp": message_dict["timestamp"]
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error sending message: {str(e)}")

@app.get("/history", response_model=List[Message])
async def get_history(limit: Optional[int] = None):
    """Get chat history with optional limit"""
    try:
        if limit and limit > 0:
            return chat_history[-limit:]
        return chat_history
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error retrieving history: {str(e)}")

@app.delete("/clear")
async def clear_history():
    """Clear all chat history"""
    try:
        chat_history.clear()
        return {"status": "Chat history cleared"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error clearing history: {str(e)}")

@app.get("/")
async def root():
    return {
        "message": "Chat API is running!",
        "docs": "/docs",
        "endpoints": {
            "send_message": "POST /chat",
            "get_history": "GET /history",
            "clear_history": "DELETE /clear"
        }
    }

# Enhanced server setup
try:
    # Kill existing tunnels
    ngrok.kill()

    # Create tunnel with authenticated account
    public_url = ngrok.connect(8000, proto="http").public_url
    print(f"ğŸš€ Public URL: {public_url}")
    print(f"ğŸ“š Swagger Docs: {public_url}/docs")
    print(f"ğŸ”— Direct API: {public_url}/chat")
    print("\nğŸ’¡ Try these commands:")
    print(f'curl -X POST "{public_url}/chat" -H "Content-Type: application/json" -d \'{{"sender": "User1", "text": "Hello World!"}}\'')
    print(f'curl "{public_url}/history"')
    print(f'curl -X DELETE "{public_url}/clear"')

except Exception as e:
    print(f"âŒ Ngrok error: {e}")
    print("ğŸ”§ Trying to run without public URL...")

# Run FastAPI server
try:
    config = uvicorn.Config(
        app=app,
        host="0.0.0.0",
        port=8000,
        log_level="info",
        access_log=True
    )
    server = uvicorn.Server(config)

    print("âœ… Server starting... Press Ctrl+C to stop")
    loop = asyncio.get_event_loop()
    loop.create_task(server.serve())

except Exception as e:
    print(f"âŒ Server error: {e}")

